<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel='stylesheet' href=../../../css/prism.css /><link rel='stylesheet' href=../../../css/index.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">

</head>
<body class="light">
    <div class='markdown-body'><h1>05-字符设备架构</h1><p>在Linux内核中，字符设备是一种特殊类型的设备，用于支持对字符流进行输入和输出。Linux字符设备架构是用于管理字符设备的一组API和数据结构。下面是Linux字符设备架构中的一些核心概念和组件</p><ul><li>设备号（Device number）：每个字符设备都有一个唯一的设备号，由主设备号和次设备号组成。主设备号通常代表设备的类型，次设备号通常代表同类型设备中的编号。</li></ul><ul><li>字符设备结构体（Character device structure）：字符设备结构体用于描述字符设备的属性和行为。它包含了设备号、设备驱动程序等信息，并用于连接字符设备和设备驱动程序。</li></ul><ul><li>设备文件（Device file）：Linux系统中的设备文件用于表示和访问设备。字符设备对应的设备文件位于/dev目录下，由系统自动创建，并使用字符设备的主设备号和次设备号来命名。</li></ul><ul><li>字符设备驱动程序（Character device driver）：字符设备驱动程序是用于管理和控制字符设备的核心组件。它包含了对字符设备结构体的操作函数，用于处理对字符设备的读写、控制等操作</li></ul><ul><li>操作函数（Operations）：操作函数是字符设备驱动程序中的一组函数，用于实现对字符设备结构体的操作。它包括读函数（read）、写函数（write）、控制函数（ioctl）等，用于处理对字符设备的读写和控制操作。</li></ul><ul><li>字符设备注册（Character device registration）：字符设备注册是指将字符设备结构体和字符设备驱动程序进行连接和注册的过程。在这个过程中，系统会分配设备号，并创建对应的设备文件。</li></ul><p>Linux字符设备架构提供了一套完整的API和数据结构，用于管理和控制字符设备。开发人员可以使用这些API和数据结构，创建自己的字符设备驱动程序，并将其与字符设备结构体进行连接和注册，实现对字符设备的管理和控制</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20221205121025.png" alt="20221205121025"></p><p>需要我们针对不同的硬件完成相应的 <code>file_operations</code> 底层实现,这样更高层统一调用函数</p><p>用户层创建字符设备驱动的办法需要借助虚拟文件系统(VFS Virtual File System)</p><p>使用mknod命令创建一个设备</p><pre><code class="language-bash">mknod /dev/hello c 233 0</code></pre><blockquote>mknod + 文件名 + 设备分类 主设备号 + 次设备号</blockquote><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20221205121725.png" alt="20221205121725"></p><p>如果想要编写程序找到驱动程序,那么就需要利用系统调用</p><pre><code class="language-c">fd = open("/dev/hello",O_RDWR);</code></pre><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20221205122042.png" alt="20221205122042"></p><p>其中fd文件描述符具有唯一性,每一次打开都会产生一个不同的fd</p><p>open调用系统调用 sys_open 然后找到 i_rdev ,找到 chrdevs中的对应 char_device_struct ,找到cdev,接下里就可以执行对应的 file_operations了</p></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/00-环境配置" >00-环境配置</a></li></ul><ul><li><a href="../../md-docs/01-module" >01-module</a></li></ul><ul><li><a href="../../md-docs/02-export" >02-export</a></li></ul><ul><li><a href="../../md-docs/03-params" >03-params</a></li></ul><ul><li><a href="../../md-docs/04-字符设备号" >04-字符设备号</a></li></ul><ul><li><a href="../../md-docs/05-字符设备架构" >05-字符设备架构</a></li></ul><ul><li><a href="../../md-docs/06-字符设备注册" >06-字符设备注册</a></li></ul><ul><li><a href="../../md-docs/07-自动创建设备节点" >07-自动创建设备节点</a></li></ul><ul><li><a href="../../md-docs/08-读写" >08-读写</a></li></ul><ul><li><a href="../../md-docs/PCI驱动" >PCI驱动</a></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank" >zood</a></div>
    <script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/prism.js"></script><script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../md-docs/04-字符设备号","../../md-docs/06-字符设备注册","ab")</script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/check_box.js"></script>
</body>
</html>