<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel='stylesheet' href=../../../css/prism.css /><link rel='stylesheet' href=../../../css/index.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">

</head>
<body class="light">
    <div class='markdown-body'><h1>07-自动创建设备节点</h1><p>之前我们需要手动使用mknod创建节点,这种方式并不优雅.很多时候需要自动创建,自动删除.这种时候我们可以使用 class 来辅助</p><pre><code class="language-c">#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/kdev_t.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/cdev.h&gt;

static int major = 233;
static int minor = 0;
static dev_t devno;
struct device *class_dev = NULL;
struct class *cls;

static int hello_open (struct inode *inode, struct file *filep)
{
    printk("hello_open()\n");
    return 0;
}
static int hello_release (struct inode *inode, struct file *filep)
{
    printk("hello_release()\n");
    return 0;
}
static struct file_operations hello_ops =
{
    .open = hello_open,
    .release = hello_release,
};
static int hello_init(void)
{
    int result;
    printk("hello_init \n");
    result = register_chrdev( major, "hello", &hello_ops);
    if(result &lt; 0)
    {
        printk("register_chrdev fail \n");
        return result;
    }
    cls = class_create(THIS_MODULE, "hellocls");
    if (IS_ERR(cls)) {
        printk(KERN_ERR "class_create() failed for cls\n");
        result = PTR_ERR(cls);
        goto out_err_1;
    }
    devno = MKDEV(major, minor);
    class_dev = device_create(cls, NULL, devno, NULL, "hellodev");
    if (IS_ERR(class_dev)) {
        result = PTR_ERR(class_dev);
        goto out_err_2;
    }
    return 0;
out_err_2:
    class_destroy(cls);
out_err_1:
    unregister_chrdev(major,"hello");
    return  result;
}
static void hello_exit(void)
{
    printk("hello_exit \n");
    device_destroy(cls, devno);
    class_destroy(cls);
    unregister_chrdev(major,"hello");
    return;
}
module_init(hello_init);
module_exit(hello_exit);
MODULE_LICENSE("GPL");
//proc/devices
</code></pre><p>以上代码新增了 <code>class_create</code> <code>device_create</code> 两个部分,用于类及类的设备创建,同时判断如果创建失败即使删除对应的设备</p><p>编译之后可以在 /sys/class 中找到我们的类</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230217163638.png" alt="20230217163638"></p><p>使用如下程序测试</p><pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
int main()
{
    int fd;
    fd = open("/dev/hellodev",O_RDWR);
    if(fd&lt;0)
    {
        perror("open fail \n");
        return 0;
    }
    close(fd);
    printf("open ok \n");
    return 0;
}</code></pre><pre><code class="language-bash">root@ubuntu:/home/lzx/Driver/cdev# insmod hello.ko
root@ubuntu:/home/lzx/Driver/cdev# ./test
open ok
root@ubuntu:/home/lzx/Driver/cdev# dmesg
[ 7253.199344] hello_init
[ 7255.249422] hello_open()
[ 7255.249423] hello_release()
root@ubuntu:/home/lzx/Driver/cdev# rmmod hello.ko
root@ubuntu:/home/lzx/Driver/cdev# dmesg
[ 7253.199344] hello_init
[ 7255.249422] hello_open()
[ 7255.249423] hello_release()
[ 7604.077653] hello_exit</code></pre><p>并且卸载之后hellocls的类也会被摧毁</p></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/00-环境配置" >00-环境配置</a></li></ul><ul><li><a href="../../md-docs/01-module" >01-module</a></li></ul><ul><li><a href="../../md-docs/02-export" >02-export</a></li></ul><ul><li><a href="../../md-docs/03-params" >03-params</a></li></ul><ul><li><a href="../../md-docs/04-字符设备号" >04-字符设备号</a></li></ul><ul><li><a href="../../md-docs/05-字符设备架构" >05-字符设备架构</a></li></ul><ul><li><a href="../../md-docs/06-字符设备注册" >06-字符设备注册</a></li></ul><ul><li><a href="../../md-docs/07-自动创建设备节点" >07-自动创建设备节点</a></li></ul><ul><li><a href="../../md-docs/08-读写" >08-读写</a></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank" >zood</a></div>
    <script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/prism.js"></script><script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../md-docs/06-字符设备注册","../../md-docs/08-读写","ab")</script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/check_box.js"></script>
</body>
</html>