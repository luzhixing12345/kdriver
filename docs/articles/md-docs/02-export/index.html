<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel='stylesheet' href=../../../css/prism.css /><link rel='stylesheet' href=../../../css/index.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">

</head>
<body class="light">
    <div class='markdown-body'><h1>02-export</h1><h2>符号导出</h2><p>Linux 内核的全局符号表在 <code>/usr/src/linux-headers-4.15.0-142-generic/Module.symvers</code> 中</p><p>模块中变量的导出可以使用 <code>EXPORT_SYMBOL</code> 宏</p><pre><code class="language-c">#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;

MODULE_LICENSE("GPL");
MODULE_AUTHOR("PD");

extern int num;
extern  void show(void);
static int hello_init(void)
{
    printk("hello_init %d\n",num);
    show();
    return 0;
}
static void hello_exit(void)
{
    printk("hello_exit \n");
    return;
}

module_init(hello_init);
module_exit(hello_exit);</code></pre><p>进入 a 目录后编译可得导出符号表 <code>Module.symvers</code>,其中包含了这两个导出的符号及其所在目录位置</p><pre><code class="language-txt">0x00000000      show    /home/lzx/Driver/export/a/helloa        EXPORT_SYMBOL
0x00000000      num     /home/lzx/Driver/export/a/helloa        EXPORT_SYMBOL</code></pre><p>接着导入模块之后可以看到输出结果</p><pre><code class="language-bash">dmesg -c
insmod helloa.ko
dmesg</code></pre><pre><code class="language-bash">[ 1156.649716] helloa: loading out-of-tree module taints kernel.
[ 1156.649759] helloa: module verification failed: signature and/or required key missing - tainting kernel
[ 1156.650809] hello_init</code></pre><p>b中的文件如下</p><pre><code class="language-c">#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;

MODULE_LICENSE("GPL");
MODULE_AUTHOR("PD");

extern int num;
extern void show(void);
static int hello_init(void)
{
    printk("hello_init %d\n",num);
    show();
    return 0;
}
static void hello_exit(void)
{
    printk("hello_exit \n");
    return;
}

module_init(hello_init);
module_exit(hello_exit);</code></pre><p>接着将a中的导出符号表复制到b中</p><pre><code class="language-bash">cp a/Module.symvers b/</code></pre><p>接下来加载 hellob.ko 之后的输出结果如下</p><pre><code class="language-bash">[ 1156.649716] helloa: loading out-of-tree module taints kernel.
[ 1156.649759] helloa: module verification failed: signature and/or required key missing - tainting kernel
[ 1156.650809] hello_init
[ 1292.628304] hello_init 100
[ 1292.628305] aaaa:  num =100</code></pre><p>可以看到成功加载,其中<code>extern int num;</code> <code>extern void show(void);</code> 导入了外部变量和外部函数</p><p>加载时必须先加载a后加载b</p><p>卸载时必须先卸载b模块再卸载a模块,如果先卸载a会出现如下错误</p><pre><code class="language-bash">root@ubuntu:/home/lzx/Driver/export/b# rmmod helloa.ko
rmmod: ERROR: Module helloa is in use by: hellob</code></pre><p>Linux 模块中有很强的依赖性,必须按顺序加载卸载</p></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/00-环境配置" >00-环境配置</a></li></ul><ul><li><a href="../../md-docs/01-module" >01-module</a></li></ul><ul><li><a href="../../md-docs/02-export" >02-export</a></li></ul><ul><li><a href="../../md-docs/03-params" >03-params</a></li></ul><ul><li><a href="../../md-docs/04-字符设备号" >04-字符设备号</a></li></ul><ul><li><a href="../../md-docs/05-字符设备架构" >05-字符设备架构</a></li></ul><ul><li><a href="../../md-docs/06-字符设备注册" >06-字符设备注册</a></li></ul><ul><li><a href="../../md-docs/07-自动创建设备节点" >07-自动创建设备节点</a></li></ul><ul><li><a href="../../md-docs/08-读写" >08-读写</a></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank" >zood</a></div>
    <script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/prism.js"></script><script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../md-docs/01-module","../../md-docs/03-params","ab")</script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/check_box.js"></script>
</body>
</html>